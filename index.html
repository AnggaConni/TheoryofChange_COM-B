<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImpactArchitect v2.3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for Radar Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">

    <!-- Marked for Markdown in Report -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        arcade: ['"Press Start 2P"', 'cursive'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'blink': 'blink 1s step-end infinite',
                    },
                    keyframes: {
                        blink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .node-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Metro Map Line */
        .metro-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #e2e8f0;
            transform: translateX(-50%);
            z-index: 0;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        /* Tour Highlight */
        .tour-highlight {
            position: relative;
            z-index: 101 !important; 
            box-shadow: 0 0 0 4px #f59e0b, 0 0 0 9999px rgba(0,0,0,0.7); 
            background-color: white;
            border-radius: 8px;
            pointer-events: auto; 
        }
        
        /* Arcade Text Shadow */
        .arcade-text {
            text-shadow: 2px 2px 0px #000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS & CONFIG ---
        const TRANSLATIONS = {
            id: {
                // Landing Page
                lp_new_title: "Program Baru",
                lp_new_subtitle: "ToC â†’ lalu COM-B",
                lp_new_desc: "Tentukan dulu perubahan sistemiknya (ToC). Identifikasi perilaku kunci, lalu uji asumsi perilaku itu pakai COM-B.",
                lp_fix_title: "Program Bermasalah",
                lp_fix_subtitle: "COM-B â†’ lalu Revisi ToC",
                lp_fix_desc: "Diagnosis dulu kenapa perilaku gagal. Temuan COM-B biasanya membongkar asumsi ToC. Update ToC berdasarkan realitas.",
                lp_tut_title: "Tutorial & Sandbox",
                lp_tut_subtitle: "Belajar & Eksperimen",
                lp_tut_desc: "Gunakan data dummy untuk latihan analisis, edit, simpan, dan export. Panduan langkah demi langkah tersedia di sini.",
                lp_modal_title: "Pilih Skenario Tutorial",
                
                // App UI
                mode_design: "Desain",
                mode_diag: "Diagnosis",
                toc_title: "Kanvas Theory of Change",
                comb_title: "Analisis Perilaku (COM-B)",
                btn_auto_complete: "Lengkapi Semua (AI)",
                btn_detect: "Deteksi Perilaku",
                btn_intervention: "Saran Intervensi",
                btn_export: "Export Laporan",
                placeholder_node: "Ketik isi atau klik ðŸª„ untuk AI...",
                placeholder_api: "Masukkan API Key Gemini...",
                lbl_impact: "Impact (Dampak)",
                lbl_outcome: "Outcome (Hasil)",
                lbl_output: "Output (Keluaran)",
                lbl_activity: "Activity (Aktivitas)",
                risk_low: "Aman",
                risk_med: "Sedang",
                risk_high: "Tinggi",
                risk_crit: "Kritis",
                empty_state: "Mulai dengan menambahkan Impact",
                manual_input_hint: "Geser slider atau klik ðŸª„ di atas untuk Auto-Diagnosa AI.",
                ai_feature: "Bantuan AI",
                magic_hint: "Isi otomatis node ini",
                api_connected: "API Key Terisi",
                api_disconnected: "API Key Kosong (Klik untuk isi)",
                get_api_key: "Dapatkan API Key di sini",
                analyzing: "Sedang Menganalisis...",
                generating_report: "Menulis Laporan Lengkap...",
                
                // Tour
                tour_next: "Lanjut",
                tour_skip: "Tutup Tutorial",
                tour_finish: "Selesai",
                tour_step1_title: "1. Kunci Kecerdasan (API Key)",
                tour_step1_desc: "Untuk menggunakan fitur AI (seperti analisis otomatis), Anda WAJIB memasukkan Gemini API Key. Klik link 'Get Key' jika belum punya.",
                tour_step2_title: "2. Kanvas Logika",
                tour_step2_desc: "Ini adalah alur logika program Anda. Klik pada kartu mana saja untuk mengedit isinya atau melihat detail.",
                tour_step3_title: "3. Tongkat Sihir (Magic Wand)",
                tour_step3_desc: "Bingung mau nulis apa? Klik ikon ini di dalam kartu. AI akan otomatis mengisi konten berdasarkan kartu sebelumnya.",
                tour_step4_title: "4. Analisis Perilaku",
                tour_step4_desc: "Setelah memilih kartu, panel ini akan muncul. Gunakan tombol 'Magic Wand' di panel ini untuk meminta AI mendiagnosa dan mengisi skor secara otomatis.",
                tour_step5_title: "5. Auto-Complete Global",
                tour_step5_desc: "Tombol ini akan meminta AI untuk melengkapi SEMUA kartu yang masih kosong sekaligus. Sangat hemat waktu!"
            },
            en: {
                // Landing Page
                lp_new_title: "New Program",
                lp_new_subtitle: "ToC â†’ then COM-B",
                lp_new_desc: "Define systemic change first (ToC). Identify key behaviors, then test behavioral assumptions using COM-B.",
                lp_fix_title: "Problematic Program",
                lp_fix_subtitle: "COM-B â†’ then Revise ToC",
                lp_fix_desc: "Diagnose why behavior failed first. COM-B findings usually reveal ToC assumptions. Update ToC based on reality.",
                lp_tut_title: "Tutorial & Sandbox",
                lp_tut_subtitle: "Learn & Experiment",
                lp_tut_desc: "Use dummy data to practice analysis, editing, saving, and exporting. Step-by-step guide included.",
                lp_modal_title: "Select Tutorial Scenario",

                // App UI
                mode_design: "Design",
                mode_diag: "Diagnosis",
                toc_title: "Theory of Change Canvas",
                comb_title: "Behavioral Analysis (COM-B)",
                btn_auto_complete: "Auto-Complete All (AI)",
                btn_detect: "Detect Behavior",
                btn_intervention: "Suggest Intervention",
                btn_export: "Export Report",
                placeholder_node: "Type here or click ðŸª„ for AI...",
                placeholder_api: "Enter Gemini API Key...",
                lbl_impact: "Impact",
                lbl_outcome: "Outcome",
                lbl_output: "Output",
                lbl_activity: "Activity",
                risk_low: "Safe",
                risk_med: "Medium",
                risk_high: "High",
                risk_crit: "Critical",
                empty_state: "Start by adding an Impact node",
                manual_input_hint: "Adjust sliders or click ðŸª„ above for AI Auto-Diagnosis.",
                ai_feature: "AI Assist",
                magic_hint: "Auto-fill this node",
                api_connected: "API Key Set",
                api_disconnected: "No API Key (Click to enter)",
                get_api_key: "Get API Key here",
                analyzing: "Analyzing...",
                generating_report: "Writing Full Report...",

                // Tour
                tour_next: "Next",
                tour_skip: "Close Tutorial",
                tour_finish: "Finish",
                tour_step1_title: "1. The Intelligence Key",
                tour_step1_desc: "To use AI features (like auto-analysis), you MUST enter a Gemini API Key. Click 'Get Key' if you don't have one.",
                tour_step2_title: "2. Logic Canvas",
                tour_step2_desc: "This is your program logic flow. Click on any card to edit its content or view details.",
                tour_step3_title: "3. Magic Wand",
                tour_step3_desc: "Stuck on wording? Click this icon inside a card. AI will auto-fill it based on the previous cards context.",
                tour_step4_title: "4. Behavioral Analysis",
                tour_step4_desc: "After selecting a card, this panel appears. Use the 'Magic Wand' button here to have AI automatically diagnose and score.",
                tour_step5_title: "5. Global Auto-Complete",
                tour_step5_desc: "This button asks AI to fill ALL empty cards at once. A massive time-saver!"
            }
        };

        const NODE_TYPES = {
            impact: { key: 'lbl_impact', color: 'from-emerald-400 to-teal-500', icon: 'fa-bullseye', bg: 'bg-emerald-50', border: 'border-emerald-200' },
            outcome: { key: 'lbl_outcome', color: 'from-blue-400 to-indigo-500', icon: 'fa-users', bg: 'bg-blue-50', border: 'border-blue-200' },
            output: { key: 'lbl_output', color: 'from-amber-400 to-orange-500', icon: 'fa-box-open', bg: 'bg-amber-50', border: 'border-amber-200' },
            activity: { key: 'lbl_activity', color: 'from-slate-400 to-slate-500', icon: 'fa-person-digging', bg: 'bg-slate-50', border: 'border-slate-200' },
        };

        const getInitialComb = () => ({
            capability: { score: 5, notes: '' },
            opportunity: { score: 5, notes: '' },
            motivation: { score: 5, notes: '' },
            summary: '',
            intervention: ''
        });

        const TUTORIAL_DATA_NEW = [
            { id: '1', type: 'impact', content: 'Kesejahteraan Petani Kopi Meningkat', risk: 'low' },
            { id: '2', type: 'outcome', content: 'Petani mengadopsi teknik fermentasi pasca-panen baru', risk: 'high' },
            { id: '3', type: 'output', content: 'Pelatihan teknis fermentasi diadakan', risk: 'low' }
        ];

        const TUTORIAL_DATA_FIX = [
            { id: '10', type: 'impact', content: 'Reduksi Stunting Balita', risk: 'low' },
            { id: '11', type: 'outcome', content: 'Ibu memberikan MPASI kaya protein setiap hari', risk: 'critical' },
            { id: '12', type: 'output', content: 'Distribusi bubuk tabur gizi', risk: 'low' }
        ];

        // --- COMPONENTS ---

        const RadarChart = ({ data, labels, onChartReady }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    const scores = [
                        data?.capability?.score || 0, 
                        data?.opportunity?.score || 0, 
                        data?.motivation?.score || 0
                    ];

                    chartRef.current = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Behavioral Strength',
                                data: scores,
                                backgroundColor: 'rgba(14, 165, 233, 0.2)',
                                borderColor: '#0ea5e9',
                                borderWidth: 2,
                                pointBackgroundColor: '#0ea5e9',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: '#e2e8f0' },
                                    grid: { color: '#e2e8f0' },
                                    suggestedMin: 0,
                                    suggestedMax: 10,
                                    ticks: { display: false }
                                }
                            },
                            plugins: { legend: { display: false } },
                            animation: {
                                onComplete: () => {
                                    // FIXED: Safe check before accessing chart properties
                                    if(onChartReady && chartRef.current && chartRef.current.canvas) {
                                        try {
                                            onChartReady(chartRef.current.toBase64Image());
                                        } catch(e) {
                                            console.warn("Chart export failed", e);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, labels]);

            return <canvas ref={canvasRef} />;
        };

        const TourOverlay = ({ step, onNext, onSkip, t }) => {
            const steps = [
                { id: 'tour-api', title: t.tour_step1_title, desc: t.tour_step1_desc, pos: 'top-24 left-20' },
                { id: 'tour-canvas', title: t.tour_step2_title, desc: t.tour_step2_desc, pos: 'top-1/3 left-1/4' },
                { id: 'tour-magic', title: t.tour_step3_title, desc: t.tour_step3_desc, pos: 'top-1/2 left-1/4' },
                { id: 'tour-comb', title: t.tour_step4_title, desc: t.tour_step4_desc, pos: 'top-20 right-1/4' },
                { id: 'tour-auto', title: t.tour_step5_title, desc: t.tour_step5_desc, pos: 'top-24 right-40' },
            ];

            const current = steps[step];
            if (!current) return null;

            return (
                <div className="fixed inset-0 z-[110] pointer-events-none">
                    <div className={`absolute ${current.pos} pointer-events-auto bg-white p-6 rounded-xl shadow-2xl max-w-sm border-l-4 border-amber-500 animate-fade-in`}>
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-lg text-slate-800">{current.title}</h3>
                            <button onClick={onSkip} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-times"></i></button>
                        </div>
                        <p className="text-sm text-slate-600 mb-4 leading-relaxed">{current.desc}</p>
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold text-amber-500 uppercase tracking-wider">Step {step + 1}/{steps.length}</span>
                            <button onClick={onNext} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-lg">
                                {step === steps.length - 1 ? t.tour_finish : t.tour_next} <i className="fa-solid fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ArcadeModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center font-arcade p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-slate-800 border-4 border-amber-400 p-8 rounded-lg max-w-md text-center shadow-[0_0_50px_rgba(251,191,36,0.3)]">
                    <div className="text-amber-400 text-4xl mb-6 animate-bounce-slow">
                        <i className="fa-solid fa-gamepad"></i>
                    </div>
                    <h2 className="text-white text-xl mb-4 leading-loose tracking-wider arcade-text">PLEASE INSERT<br/><span className="text-amber-400">API KEY</span></h2>
                    <p className="text-slate-400 text-xs font-sans mb-8 leading-relaxed">
                        To unlock the magic powers of AI, you need a Gemini Coin (API Key). It's free!
                    </p>
                    <div className="flex flex-col gap-3">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" className="bg-amber-500 hover:bg-amber-400 text-black py-3 px-6 rounded text-xs font-bold transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] active:translate-y-1 active:shadow-none uppercase">
                            GET KEY <i className="fa-solid fa-external-link-alt ml-2"></i>
                        </a>
                        <button onClick={onClose} className="text-slate-500 hover:text-white text-xs mt-2 font-sans underline">
                            I'll enter it later
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APPLICATION ---
        function App() {
            const [lang, setLang] = useState('en');
            const [mode, setMode] = useState(null); 
            const [isTutorial, setIsTutorial] = useState(false);
            const [showTutorialModal, setShowTutorialModal] = useState(false);
            const [tourStep, setTourStep] = useState(-1);
            const [showArcadeModal, setShowArcadeModal] = useState(false);
            
            const [nodes, setNodes] = useState([]);
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [combData, setCombData] = useState({});
            const [apiKey, setApiKey] = useState('');
            const [loadingState, setLoadingState] = useState({ global: false, node: null });
            const [chartImage, setChartImage] = useState(null);

            const t = TRANSLATIONS[lang];
            const selectedNode = nodes.find(n => n.id === selectedNodeId);
            const nodeComb = (selectedNodeId && combData[selectedNodeId]) ? combData[selectedNodeId] : getInitialComb();

            // --- INITIALIZATION ---
            const startSession = (sessionMode, isTut, initialData = []) => {
                setMode(sessionMode);
                setIsTutorial(isTut);
                setNodes(initialData);
                setShowTutorialModal(false);
                setCombData({});
                setSelectedNodeId(null);
                if (isTut) {
                    setTourStep(0);
                    if(initialData.length > 0) setTimeout(() => setSelectedNodeId(initialData[0].id), 500); 
                } else {
                    setTourStep(-1);
                }
            };

            // --- CORE LOGIC ---
            const handleNodeClick = (id) => {
                setSelectedNodeId(id);
                if (!combData[id]) setCombData(prev => ({ ...prev, [id]: getInitialComb() }));
            };

            const addNode = (type) => {
                const newId = Date.now().toString();
                const newNode = { id: newId, type, content: '', risk: 'low' };
                setNodes(prev => [...prev, newNode]);
                handleNodeClick(newId);
            };

            const updateNode = (id, field, value) => {
                setNodes(nodes.map(n => n.id === id ? { ...n, [field]: value } : n));
            };

            const deleteNode = (id, e) => {
                e.stopPropagation();
                setNodes(nodes.filter(n => n.id !== id));
                if (selectedNodeId === id) setSelectedNodeId(null);
            };

            const updateComb = (category, field, value) => {
                setCombData(prev => {
                    const existingNode = prev[selectedNodeId] || getInitialComb();
                    const existingCat = existingNode[category] || { score: 5, notes: '' };
                    return { ...prev, [selectedNodeId]: { ...existingNode, [category]: { ...existingCat, [field]: value } } };
                });
                setTimeout(() => calculateRisk(selectedNodeId), 0);
            };

            const calculateRisk = (nodeId) => {
                setCombData(current => {
                    const data = current[nodeId];
                    if (!data) return current;
                    const c = data.capability?.score || 5;
                    const o = data.opportunity?.score || 5;
                    const m = data.motivation?.score || 5;
                    const avg = (parseInt(c) + parseInt(o) + parseInt(m)) / 3;
                    let risk = 'low';
                    if (avg < 4) risk = 'critical';
                    else if (avg < 6) risk = 'high';
                    else if (avg < 8) risk = 'medium';
                    setNodes(prev => prev.map(n => n.id === nodeId ? { ...n, risk } : n));
                    return current;
                });
            };

            // --- SAVE / LOAD ---
            const saveProject = () => {
                const data = { nodes, combData, mode, lang };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `impact_architect_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const loadProject = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.nodes) setNodes(data.nodes);
                        if(data.combData) setCombData(data.combData);
                        if(data.mode) setMode(data.mode);
                        alert("Project loaded!");
                    } catch(err) { alert("Invalid file"); }
                };
                reader.readAsText(file);
            };

            // --- AI INTEGRATION ---
            const callGemini = async (prompt, systemInstruction = "") => {
                if (!apiKey) {
                    setShowArcadeModal(true);
                    return null;
                }
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                    });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) { console.error(e); return "Error."; }
            };

            const aiFillNode = async (nodeId, type, currentContent) => {
                setLoadingState({ global: false, node: nodeId });
                const nodeIndex = nodes.findIndex(n => n.id === nodeId);
                const prevNode = nodeIndex > 0 ? nodes[nodeIndex - 1] : null;
                const context = prevNode ? `Preceding step: "${prevNode.content}"` : "This is the starting point.";
                const prompt = `Generate a realistic and specific ${type.toUpperCase()} for a development program. ${context}. Current draft: "${currentContent}". Output ONLY the content text.`;
                const res = await callGemini(prompt, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if (res) updateNode(nodeId, 'content', res);
                setLoadingState({ global: false, node: null });
            };

            const aiAutoCompleteAll = async () => {
                setLoadingState({ global: true, node: null });
                for (const node of nodes) {
                    if (!node.content || node.content.trim() === '') {
                        await aiFillNode(node.id, node.type, "");
                        await new Promise(r => setTimeout(r, 500)); 
                    }
                }
                setLoadingState({ global: false, node: null });
            };

            // NEW: Magic Wand for COM-B (Auto-Diagnose)
            const aiMagicComb = async () => {
                if (!selectedNode) return;
                setLoadingState({ global: true, node: null });
                
                const prompt = `Analyze: "${selectedNode.content}". Estimate behavioral scores (1-10) for Capability, Opportunity, Motivation. Provide very short notes for each. Return valid JSON ONLY: { "c_score": 5, "c_note": "...", "o_score": 5, "o_note": "...", "m_score": 5, "m_note": "..." }`;
                
                const res = await callGemini(prompt, "You are a JSON generator.");
                if (res) {
                    try {
                        const cleanRes = res.replace(/```json/g, '').replace(/```/g, '');
                        const json = JSON.parse(cleanRes);
                        setCombData(prev => ({
                            ...prev,
                            [selectedNodeId]: {
                                ...prev[selectedNodeId],
                                capability: { score: json.c_score, notes: json.c_note },
                                opportunity: { score: json.o_score, notes: json.o_note },
                                motivation: { score: json.m_score, notes: json.m_note },
                                summary: "Auto-diagnosed by AI"
                            }
                        }));
                        setTimeout(() => calculateRisk(selectedNodeId), 500);
                    } catch (e) { console.error("JSON Parse Error", e); }
                }
                setLoadingState({ global: false, node: null });
            };

            const aiAnalyzeBehavior = async () => {
                if (!selectedNode) return;
                setLoadingState({ global: true, node: null });
                const res = await callGemini(`Analyze specific behavior for: "${selectedNode.content}". Identify WHO needs to do WHAT.`, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if(res) setCombData(prev => ({ ...prev, [selectedNodeId]: { ...(prev[selectedNodeId] || getInitialComb()), summary: res } }));
                setLoadingState({ global: false, node: null });
            };

            const aiSuggestIntervention = async () => {
                 if (!selectedNode) return;
                setLoadingState({ global: true, node: null });
                const d = nodeComb;
                const prompt = `Scores C:${d.capability.score}, O:${d.opportunity.score}, M:${d.motivation.score} for "${selectedNode.content}". Suggest 3 interventions.`;
                const res = await callGemini(prompt, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if(res) setCombData(prev => ({ ...prev, [selectedNodeId]: { ...(prev[selectedNodeId] || getInitialComb()), intervention: res } }));
                setLoadingState({ global: false, node: null });
            };

            const exportReport = async () => {
                if(!apiKey) { setShowArcadeModal(true); return; }
                setLoadingState({ global: true, node: 'export' });

                // 1. Get Comprehensive AI Analysis
                const tocText = nodes.map(n => `[${n.type}] ${n.content}`).join(' -> ');
                const aiReport = await callGemini(`
                    Review this Theory of Change: ${tocText}.
                    Write a comprehensive strategic report including:
                    1. Executive Summary
                    2. Logic Flow Analysis
                    3. Behavioral Risk Assessment
                    4. Strategic Recommendations.
                    Use Markdown.
                `, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}. Professional consultant tone.`);

                setLoadingState({ global: false, node: null });

                const html = `
                    <html><head><title>ImpactArchitect Strategic Report</title>
                    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Plus Jakarta Sans', sans-serif; padding: 40px; color: #1e293b; max-width: 900px; margin: 0 auto; line-height: 1.6; }
                        h1 { color: #0f172a; border-bottom: 3px solid #0ea5e9; padding-bottom: 15px; margin-bottom: 20px; font-size: 24px; }
                        h2 { color: #0ea5e9; margin-top: 30px; font-size: 18px; border-left: 4px solid #0ea5e9; padding-left: 10px; }
                        .diagram-container { background: #f8fafc; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 20px 0; text-align: center; }
                        .node-box { 
                            padding: 10px 15px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; 
                            margin: 10px auto; width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: left; position: relative;
                        }
                        .arrow { color: #cbd5e1; font-size: 20px; margin: 5px 0; }
                        .badge { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #64748b; margin-bottom: 5px; display: block; }
                        .risk-high { border-left: 4px solid #f97316; } .risk-critical { border-left: 4px solid #ef4444; }
                        .ai-content { background: #fff; padding: 20px; border-radius: 8px; }
                        .radar-snapshot { float: right; width: 300px; margin: 0 0 20px 20px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
                    </style>
                    </head><body>
                    <h1>ImpactArchitect Strategic Report</h1>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <h2>1. Theory of Change Diagram</h2>
                    <div class="diagram-container">
                        ${nodes.map((n, i) => `
                            <div class="node-box ${n.risk === 'high' || n.risk === 'critical' ? 'risk-' + n.risk : ''}">
                                <span class="badge">${n.type}</span>
                                <strong>${n.content}</strong>
                            </div>
                            ${i < nodes.length - 1 ? '<div class="arrow">â†“</div>' : ''}
                        `).join('')}
                    </div>

                    ${chartImage ? `<img src="${chartImage}" class="radar-snapshot" />` : ''}

                    <h2>2. AI Strategic Analysis</h2>
                    <div class="ai-content">
                        ${marked.parse(aiReport || 'Analysis unavailable.')}
                    </div>

                    <h2>3. Detailed Behavioral Register</h2>
                    ${Object.entries(combData).map(([k,v]) => {
                         const n = nodes.find(x=>x.id===k);
                         return n ? `<div class="node-box"><strong>Target:</strong> ${n.content}<br><br><strong>Diagnosis:</strong> ${v.summary}<br><strong>Intervention:</strong> ${v.intervention}</div>` : ''
                    }).join('')}
                    
                    <script>window.print()<\/script></body></html>
                `;
                const w = window.open(); w.document.write(html); w.document.close();
            };

            const RiskTag = ({ level }) => {
                const colors = { low: 'bg-emerald-100 text-emerald-700', medium: 'bg-yellow-100 text-yellow-700', high: 'bg-orange-100 text-orange-700', critical: 'bg-red-100 text-red-700' };
                return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase ${colors[level]}`}>{t[`risk_${level}`]}</span>;
            };

            // --- RENDER ---
            if (!mode) return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white relative overflow-hidden">
                     <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '30px 30px'}}></div>
                    <button onClick={() => setLang(lang === 'en' ? 'id' : 'en')} className="absolute top-6 right-6 text-xs font-bold bg-slate-800 px-3 py-1 rounded border border-slate-700 hover:border-blue-500 z-10">{lang.toUpperCase()}</button>
                    <div className="max-w-6xl w-full z-10">
                        <div className="text-center mb-12">
                            <h1 className="text-6xl font-bold mb-4 tracking-tight flex justify-center items-center gap-4">
                                <span className="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">ImpactArchitect</span>
                            </h1>
                            <p className="text-slate-400 text-xl font-light">Behaviorally-Informed Policy IDE</p>
                        </div>
                        <div className="grid md:grid-cols-3 gap-6">
                            <button onClick={() => startSession('design', false, [])} className="group bg-slate-800/80 backdrop-blur p-8 rounded-2xl border border-slate-700 hover:border-blue-500 transition-all hover:-translate-y-2 text-left h-full flex flex-col relative overflow-hidden">
                                <div className="w-14 h-14 bg-blue-500/20 rounded-xl flex items-center justify-center mb-6 border border-blue-500/30"><i className="fa-solid fa-pen-ruler text-2xl text-blue-400"></i></div>
                                <h2 className="text-2xl font-bold mb-1 text-white">{t.lp_new_title}</h2>
                                <p className="text-sm text-slate-400 leading-relaxed mt-2">{t.lp_new_desc}</p>
                            </button>
                            <button onClick={() => startSession('diag', false, [])} className="group bg-slate-800/80 backdrop-blur p-8 rounded-2xl border border-slate-700 hover:border-red-500 transition-all hover:-translate-y-2 text-left h-full flex flex-col relative overflow-hidden">
                                <div className="w-14 h-14 bg-red-500/20 rounded-xl flex items-center justify-center mb-6 border border-red-500/30"><i className="fa-solid fa-stethoscope text-2xl text-red-400"></i></div>
                                <h2 className="text-2xl font-bold mb-1 text-white">{t.lp_fix_title}</h2>
                                <p className="text-sm text-slate-400 leading-relaxed mt-2">{t.lp_fix_desc}</p>
                            </button>
                            <button onClick={() => setShowTutorialModal(true)} className="group bg-slate-800/80 backdrop-blur p-8 rounded-2xl border border-slate-700 hover:border-amber-500 transition-all hover:-translate-y-2 text-left h-full flex flex-col relative overflow-hidden">
                                <div className="w-14 h-14 bg-amber-500/20 rounded-xl flex items-center justify-center mb-6 border border-amber-500/30"><i className="fa-solid fa-flask text-2xl text-amber-400"></i></div>
                                <h2 className="text-2xl font-bold mb-1 text-white">{t.lp_tut_title}</h2>
                                <p className="text-sm text-slate-400 leading-relaxed mt-2">{t.lp_tut_desc}</p>
                            </button>
                        </div>
                    </div>
                    {showTutorialModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white text-slate-900 rounded-xl p-6 max-w-md w-full animate-fade-in shadow-2xl">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><i className="fa-solid fa-graduation-cap text-amber-500"></i> {t.lp_modal_title}</h3>
                                <div className="space-y-3">
                                    <button onClick={() => startSession('design', true, TUTORIAL_DATA_NEW)} className="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all group font-bold text-slate-800">{t.lp_new_title} (Demo)</button>
                                    <button onClick={() => startSession('diag', true, TUTORIAL_DATA_FIX)} className="w-full text-left p-4 rounded-lg border border-slate-200 hover:border-red-500 hover:bg-red-50 transition-all group font-bold text-slate-800">{t.lp_fix_title} (Demo)</button>
                                </div>
                                <button onClick={() => setShowTutorialModal(false)} className="mt-4 w-full py-2 text-sm font-bold text-slate-400 hover:text-slate-600">Cancel</button>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-800">
                    {showArcadeModal && <ArcadeModal onClose={() => setShowArcadeModal(false)} />}
                    {isTutorial && tourStep >= 0 && <TourOverlay step={tourStep} t={t} onNext={() => setTourStep(prev => prev >= 4 ? -1 : prev + 1)} onSkip={() => setTourStep(-1)} />}

                    <nav className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-50 relative shadow-sm">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setMode(null)} className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white hover:bg-slate-700 transition-colors"><i className="fa-solid fa-home"></i></button>
                            <div>
                                <h1 className="font-bold text-lg leading-tight tracking-tight">ImpactArchitect <span className="text-blue-500">2.3</span></h1>
                                <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded text-white ${isTutorial ? 'bg-amber-500' : mode === 'design' ? 'bg-blue-500' : 'bg-red-500'}`}>{isTutorial ? 'SANDBOX' : mode === 'design' ? t.mode_design.toUpperCase() : t.mode_diag.toUpperCase()}</span>
                            </div>
                        </div>
                        <div className={`flex-1 max-w-md mx-6 ${tourStep === 0 ? 'tour-highlight' : ''}`}>
                            <div className={`flex items-center gap-3 bg-slate-50 border transition-colors rounded-lg px-3 py-1.5 ${apiKey ? 'border-emerald-500/50 bg-emerald-50/30' : 'border-slate-200 focus-within:border-blue-500'}`}>
                                <div className={`status-dot shrink-0 ${apiKey ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-slate-300'}`} title={apiKey ? t.api_connected : t.api_disconnected}></div>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder={t.placeholder_api} className="w-full bg-transparent text-xs font-medium focus:outline-none text-slate-700 placeholder-slate-400" />
                            </div>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-[10px] text-blue-500 hover:text-blue-700 font-medium ml-1 mt-1 block flex items-center gap-1"><i className="fa-solid fa-external-link-alt"></i> {t.get_api_key}</a>
                        </div>
                        <div className={`flex items-center gap-3 ${tourStep === 4 ? 'tour-highlight' : ''}`}>
                             <button onClick={() => setLang(lang === 'en' ? 'id' : 'en')} className="px-3 py-1.5 text-xs font-bold border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">{lang.toUpperCase()}</button>
                            <button onClick={aiAutoCompleteAll} disabled={loadingState.global} className={`flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 ${loadingState.global ? 'opacity-70 cursor-wait' : ''}`}>
                                {loadingState.global ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles text-purple-400"></i>}
                                {t.btn_auto_complete}
                            </button>
                            <div className="flex gap-1">
                                <label className="p-2 text-slate-400 hover:text-blue-600 transition-colors cursor-pointer" title="Load JSON"><input type="file" accept=".json" onChange={loadProject} className="hidden" /><i className="fa-solid fa-upload"></i></label>
                                <button onClick={saveProject} className="p-2 text-slate-400 hover:text-blue-600 transition-colors" title="Save JSON"><i className="fa-solid fa-download"></i></button>
                                <button onClick={exportReport} disabled={loadingState.global} className="p-2 text-slate-400 hover:text-blue-600 transition-colors" title={t.btn_export}>{loadingState.node === 'export' ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-print"></i>}</button>
                            </div>
                        </div>
                    </nav>

                    <div className="flex-1 flex overflow-hidden">
                        <div className={`flex-1 bg-slate-50/50 relative overflow-hidden flex flex-col ${tourStep === 1 ? 'tour-highlight' : ''}`}>
                            <div className="h-12 border-b border-slate-200 bg-white/80 backdrop-blur px-6 flex items-center gap-4 z-10">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest mr-2">{t.toc_title}</span>
                                {Object.keys(NODE_TYPES).map(type => (
                                    <button key={type} onClick={() => addNode(type)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider transition-all hover:scale-105 border ${NODE_TYPES[type].bg} ${NODE_TYPES[type].border}`}>
                                        <i className={`fa-solid ${NODE_TYPES[type].icon} opacity-60`}></i>
                                        {t[NODE_TYPES[type].key].split(' ')[0]} <span className="ml-1 opacity-50">+</span>
                                    </button>
                                ))}
                            </div>
                            <div className="flex-1 overflow-y-auto overflow-x-hidden relative p-8 custom-scrollbar">
                                <div className="metro-line"></div>
                                <div className="max-w-3xl mx-auto space-y-8 pb-20 relative z-10">
                                    {nodes.length === 0 ? (
                                        <div className="text-center py-20 opacity-40">
                                            <i className="fa-solid fa-diagram-project text-6xl mb-4 text-slate-300"></i>
                                            <p className="text-slate-500 font-medium">{t.empty_state}</p>
                                        </div>
                                    ) : (
                                        ['impact', 'outcome', 'output', 'activity'].map(layer => {
                                            const layerNodes = nodes.filter(n => n.type === layer);
                                            if (layerNodes.length === 0) return null;
                                            return (
                                                <div key={layer} className="relative">
                                                    <div className="absolute -left-32 top-6 text-right w-24"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{t[NODE_TYPES[layer].key].split(' ')[0]}</span></div>
                                                    <div className="grid gap-4">
                                                        {layerNodes.map(node => (
                                                            <div key={node.id} onClick={() => handleNodeClick(node.id)} className={`node-card group relative bg-white rounded-xl border p-4 cursor-pointer ${selectedNodeId === node.id ? 'border-blue-500 ring-4 ring-blue-500/10' : 'border-slate-200'} ${node.risk === 'critical' ? 'border-l-4 border-l-red-500' : ''}`}>
                                                                <button onClick={(e) => { e.stopPropagation(); aiFillNode(node.id, node.type, node.content); }} className={`absolute top-2 right-2 w-6 h-6 rounded flex items-center justify-center text-slate-300 hover:text-purple-500 hover:bg-purple-50 transition-colors ${tourStep === 2 ? 'bg-amber-100 text-amber-500 animate-bounce-slow shadow-lg ring-2 ring-amber-400' : ''}`} title={t.magic_hint}>
                                                                    {loadingState.node === node.id ? <i className="fa-solid fa-circle-notch fa-spin text-xs"></i> : <i className="fa-solid fa-wand-magic-sparkles text-xs"></i>}
                                                                </button>
                                                                <div className="flex items-start gap-4">
                                                                    <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${NODE_TYPES[node.type].color} flex items-center justify-center text-white shadow-md shrink-0`}><i className={`fa-solid ${NODE_TYPES[node.type].icon}`}></i></div>
                                                                    <div className="flex-1">
                                                                        <textarea value={node.content} onChange={(e) => updateNode(node.id, 'content', e.target.value)} placeholder={t.placeholder_node} className="w-full bg-transparent border-none p-0 text-sm font-medium text-slate-700 placeholder-slate-300 focus:ring-0 resize-none h-auto leading-relaxed" rows={2} />
                                                                        <div className="flex items-center justify-between mt-2 pt-2 border-t border-slate-50">
                                                                            <RiskTag level={node.risk} />
                                                                            <button onClick={(e) => deleteNode(node.id, e)} className="text-slate-300 hover:text-red-400 text-xs"><i className="fa-solid fa-trash"></i></button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className={`w-[400px] bg-white border-l border-slate-200 flex flex-col shadow-2xl z-30 transition-transform duration-300 ${!selectedNode ? 'translate-x-full absolute right-0 h-full' : 'translate-x-0 relative'} ${tourStep === 3 ? 'tour-highlight' : ''}`}>
                            {selectedNode ? (
                                <>
                                    <div className="h-14 border-b border-slate-100 flex items-center justify-between px-6 bg-slate-50">
                                        <div className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wide"><i className="fa-solid fa-sliders text-blue-500"></i> {t.comb_title}</div>
                                        <div className="flex gap-2">
                                            <button onClick={aiMagicComb} className="w-6 h-6 rounded flex items-center justify-center text-purple-500 bg-purple-50 hover:bg-purple-100 transition-colors" title="Magic Auto-Diagnose"><i className="fa-solid fa-wand-magic-sparkles text-xs"></i></button>
                                            <button onClick={() => setSelectedNodeId(null)} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-xmark"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                                        <div className="h-48 mb-6 relative">
                                            <RadarChart data={nodeComb} labels={[t.capability, t.opportunity, t.motivation]} onChartReady={setChartImage} />
                                        </div>
                                        <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-6 flex items-start gap-3">
                                            <i className="fa-solid fa-info-circle text-blue-500 mt-0.5"></i>
                                            <p className="text-xs text-blue-800 leading-relaxed">{t.manual_input_hint}</p>
                                        </div>
                                        <div className="space-y-6">
                                            {['capability', 'opportunity', 'motivation'].map(domain => {
                                                const domainData = nodeComb[domain] || { score: 5, notes: '' };
                                                return (
                                                    <div key={domain} className="group">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <label className="capitalize text-sm font-bold text-slate-700">{domain}</label>
                                                            <span className="text-xs font-mono font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{domainData.score}/10</span>
                                                        </div>
                                                        <input type="range" min="1" max="10" value={domainData.score} onChange={(e) => updateComb(domain, 'score', e.target.value)} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2" />
                                                        <textarea value={domainData.notes} onChange={(e) => updateComb(domain, 'notes', e.target.value)} placeholder={`Notes for ${domain}...`} className="w-full text-xs p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-400 transition-colors resize-none" rows={2}></textarea>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="mt-8 pt-6 border-t border-slate-100">
                                            <div className="flex justify-between items-center mb-4">
                                                <h4 className="text-sm font-bold text-slate-800"><i className="fa-solid fa-robot text-purple-500 mr-2"></i>{t.ai_feature}</h4>
                                                <div className="flex gap-2">
                                                    <button onClick={aiAnalyzeBehavior} className="text-[10px] font-bold bg-white border border-slate-200 px-2 py-1 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors">Analysis</button>
                                                    <button onClick={aiSuggestIntervention} className="text-[10px] font-bold bg-white border border-slate-200 px-2 py-1 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors">Intervention</button>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                {loadingState.global && !loadingState.node ? (
                                                    <div className="animate-pulse flex space-x-4"><div className="flex-1 space-y-2 py-1"><div className="h-2 bg-slate-200 rounded"></div><div className="h-2 bg-slate-200 rounded w-5/6"></div></div></div>
                                                ) : (
                                                    <>
                                                        <div className="p-3 bg-purple-50 border border-purple-100 rounded-lg"><div className="text-[10px] font-bold text-purple-700 uppercase mb-1">Diagnosis</div><p className="text-xs text-slate-700">{nodeComb.summary || "-"}</p></div>
                                                        <div className="p-3 bg-indigo-50 border border-indigo-100 rounded-lg"><div className="text-[10px] font-bold text-indigo-700 uppercase mb-1">Recommendation</div><p className="text-xs text-slate-700 whitespace-pre-line">{nodeComb.intervention || "-"}</p></div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : null}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
