<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImpactArchitect v2.9 - Angga Conni Saputra</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js for Radar Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">

    <!-- Marked for Markdown in Report -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        arcade: ['"Press Start 2P"', 'cursive'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'blink': 'blink 1s step-end infinite',
                        'fade-in': 'fadeIn 0.3s ease-in',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        blink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px) translateX(-50%)' },
                            '100%': { opacity: '1', transform: 'translateY(0) translateX(-50%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .node-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .node-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Metro Map Line */
        .metro-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #e2e8f0;
            transform: translateX(-50%);
            z-index: 0;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        /* Tour Highlight */
        .tour-highlight {
            position: relative;
            z-index: 101 !important; 
            box-shadow: 0 0 0 4px #f59e0b, 0 0 0 9999px rgba(0,0,0,0.7); 
            background-color: white;
            border-radius: 8px;
            pointer-events: auto; 
        }
        
        /* Arcade Text Shadow */
        .arcade-text {
            text-shadow: 2px 2px 0px #000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS & CONFIG ---
        const TRANSLATIONS = {
            id: {
                // Landing Page
                lp_new_title: "Mulai Program Baru",
                lp_new_subtitle: "Desain & Diagnosis",
                lp_new_desc: "Kanvas kosong untuk merancang ToC baru atau mendiagnosis program yang gagal. Termasuk fitur analisis COM-B lengkap.",
                
                lp_tut_title: "Tutorial & Sandbox",
                lp_tut_subtitle: "Belajar & Eksperimen",
                lp_tut_desc: "Gunakan data dummy untuk latihan analisis, edit, simpan, dan export. Panduan langkah demi langkah tersedia di sini.",
                
                lp_modal_title: "Pilih Skenario Tutorial",
                
                // Tutorial Scenarios
                tut_scenario1_title: "ðŸŒ± Kesejahteraan Petani Kopi",
                tut_scenario1_desc: "Audit ToC program peningkatan pendapatan petani melalui adopsi fermentasi kopi. Identifikasi asumsi perilaku yang lemah dan perbaiki.",
                tut_scenario1_difficulty: "Pemula",
                tut_scenario2_title: "ðŸ‘¶ Reduksi Stunting Balita",
                tut_scenario2_desc: "Diagnosis program gizi yang gagal. Output tercapai (distribusi berjalan) tapi outcome tidak (ibu tidak berubah perilaku). Temukan akar masalahnya.",
                tut_scenario2_difficulty: "Menengah",
                tut_what_learn: "Yang Akan Dipelajari:",
                tut_start: "Mulai Tutorial",
                tut_back: "Kembali",
                
                // App UI
                mode_label: "Workspace",
                toc_title: "Kanvas Theory of Change",
                comb_title: "Analisis Perilaku (COM-B)",
                btn_auto_complete: "Lengkapi Semua (AI)",
                btn_detect: "Deteksi Perilaku",
                btn_intervention: "Saran Intervensi",
                btn_export: "Export Laporan",
                placeholder_node: "Ketik isi atau klik ðŸª„ untuk AI...",
                placeholder_api: "Masukkan API Key Gemini...",
                placeholder_project: "Judul Project...",
                lbl_impact: "Impact (Dampak)",
                lbl_outcome: "Outcome (Hasil)",
                lbl_output: "Output (Keluaran)",
                lbl_activity: "Activity (Aktivitas)",
                risk_low: "Aman",
                risk_med: "Sedang",
                risk_high: "Tinggi",
                risk_crit: "Kritis",
                empty_state: "Mulai dengan menambahkan Impact",
                manual_input_hint: "Geser slider atau klik ðŸª„ di atas untuk Auto-Diagnosa AI.",
                ai_feature: "Bantuan AI",
                magic_hint: "Isi otomatis node ini",
                api_connected: "API Key Terisi",
                api_disconnected: "API Key Kosong (Klik untuk isi)",
                get_api_key: "Dapatkan API Key di sini",
                analyzing: "Sedang Menganalisis...",
                generating_report: "Menulis Laporan Lengkap...",
                capability: "Kemampuan",
                opportunity: "Kesempatan",
                motivation: "Motivasi",
                
                // Tour
                tour_next: "Lanjut",
                tour_skip: "Tutup Tutorial",
                tour_finish: "Selesai",
                tour_step1_title: "1. Kunci Kecerdasan (API Key)",
                tour_step1_desc: "Untuk menggunakan fitur AI (seperti analisis otomatis), Anda WAJIB memasukkan Gemini API Key. Klik link 'Get Key' jika belum punya.",
                tour_step2_title: "2. Judul & Kanvas",
                tour_step2_desc: "Beri nama program Anda di bagian judul. Klik tombol + di toolbar untuk menambah kartu baru.",
                tour_step3_title: "3. Tongkat Sihir (Magic Wand)",
                tour_step3_desc: "Bingung mau nulis apa? Klik ikon ini di dalam kartu. AI akan otomatis mengisi konten berdasarkan kartu sebelumnya.",
                tour_step4_title: "4. Analisis Perilaku",
                tour_step4_desc: "Setelah memilih kartu, panel ini akan muncul. Gunakan tombol 'Magic Wand' di panel ini untuk meminta AI mendiagnosa dan mengisi skor secara otomatis.",
                tour_step5_title: "5. Auto-Complete Global",
                tour_step5_desc: "Tombol ini akan meminta AI untuk melengkapi SEMUA kartu yang masih kosong sekaligus. Sangat hemat waktu!"
            },
            en: {
                // Landing Page
                lp_new_title: "Start New Program",
                lp_new_subtitle: "Design & Diagnose",
                lp_new_desc: "Blank canvas to design a new ToC or diagnose a failed program. Includes full COM-B analysis features.",
                
                lp_tut_title: "Tutorial & Sandbox",
                lp_tut_subtitle: "Learn & Experiment",
                lp_tut_desc: "Use dummy data to practice analysis, editing, saving, and exporting. Step-by-step guide included.",
                
                lp_modal_title: "Select Tutorial Scenario",

                // Tutorial Scenarios
                tut_scenario1_title: "ðŸŒ± Coffee Farmer Welfare",
                tut_scenario1_desc: "Audit a ToC for farmer income improvement through coffee fermentation adoption. Identify weak behavioral assumptions and improve them.",
                tut_scenario1_difficulty: "Beginner",
                tut_scenario2_title: "ðŸ‘¶ Child Stunting Reduction",
                tut_scenario2_desc: "Diagnose a failed nutrition program. Output achieved (distribution works) but outcome didn't (mothers didn't change behavior). Find the root cause.",
                tut_scenario2_difficulty: "Intermediate",
                tut_what_learn: "What You'll Learn:",
                tut_start: "Start Tutorial",
                tut_back: "Back",

                // App UI
                mode_label: "Workspace",
                toc_title: "Theory of Change Canvas",
                comb_title: "Behavioral Analysis (COM-B)",
                btn_auto_complete: "Auto-Complete All (AI)",
                btn_detect: "Detect Behavior",
                btn_intervention: "Suggest Intervention",
                btn_export: "Export Report",
                placeholder_node: "Type here or click ðŸª„ for AI...",
                placeholder_api: "Enter Gemini API Key...",
                placeholder_project: "Project Name...",
                lbl_impact: "Impact",
                lbl_outcome: "Outcome",
                lbl_output: "Output",
                lbl_activity: "Activity",
                risk_low: "Safe",
                risk_med: "Medium",
                risk_high: "High",
                risk_crit: "Critical",
                empty_state: "Start by adding an Impact node",
                manual_input_hint: "Adjust sliders or click ðŸª„ above for AI Auto-Diagnosis.",
                ai_feature: "AI Assist",
                magic_hint: "Auto-fill this node",
                api_connected: "API Key Set",
                api_disconnected: "No API Key (Click to enter)",
                get_api_key: "Get API Key here",
                analyzing: "Analyzing...",
                generating_report: "Writing Full Report...",
                capability: "Capability",
                opportunity: "Opportunity",
                motivation: "Motivation",

                // Tour
                tour_next: "Next",
                tour_skip: "Close Tutorial",
                tour_finish: "Finish",
                tour_step1_title: "1. The Intelligence Key",
                tour_step1_desc: "To use AI features (like auto-analysis), you MUST enter a Gemini API Key. Click 'Get Key' if you don't have one.",
                tour_step2_title: "2. Title & Canvas",
                tour_step2_desc: "Name your program in the large title area. Use the toolbar buttons to add new logic cards.",
                tour_step3_title: "3. Magic Wand",
                tour_step3_desc: "Stuck on wording? Click this icon inside a card. AI will auto-fill it based on the previous cards context.",
                tour_step4_title: "4. Behavioral Analysis",
                tour_step4_desc: "After selecting a card, this panel appears. Use the 'Magic Wand' button here to have AI automatically diagnose and score.",
                tour_step5_title: "5. Global Auto-Complete",
                tour_step5_desc: "This button asks AI to fill ALL empty cards at once. A massive time-saver!"
            }
        };

        const NODE_TYPES = {
            impact: { key: 'lbl_impact', color: 'from-emerald-400 to-teal-500', icon: 'fa-bullseye', bg: 'bg-emerald-50', border: 'border-emerald-200' },
            outcome: { key: 'lbl_outcome', color: 'from-blue-400 to-indigo-500', icon: 'fa-users', bg: 'bg-blue-50', border: 'border-blue-200' },
            output: { key: 'lbl_output', color: 'from-amber-400 to-orange-500', icon: 'fa-box-open', bg: 'bg-amber-50', border: 'border-amber-200' },
            activity: { key: 'lbl_activity', color: 'from-slate-400 to-slate-500', icon: 'fa-person-digging', bg: 'bg-slate-50', border: 'border-slate-200' },
        };

        const getInitialComb = () => ({
            capability: { score: 5, notes: '' },
            opportunity: { score: 5, notes: '' },
            motivation: { score: 5, notes: '' },
            summary: '',
            intervention: ''
        });

        // --- PRE-POPULATED TUTORIAL SCENARIOS ---
        const TUTORIAL_SCENARIOS = {
            scenario1: {
                id: 'scenario1',
                mode: 'design',
                titleEN: 'Coffee Farmer Welfare Program - West Java',
                titleID: 'Program Kesejahteraan Petani Kopi - Jawa Barat',
                nodes: [
                    { 
                        id: '1', 
                        type: 'impact', 
                        content: 'Increase average household income of smallholder coffee farmers by 40% within 2 years',
                        risk: 'low' 
                    },
                    { 
                        id: '2', 
                        type: 'outcome', 
                        content: 'Farmers adopt wet-hulling fermentation technique and sell specialty-grade coffee to premium buyers',
                        risk: 'high' 
                    },
                    { 
                        id: '3', 
                        type: 'output', 
                        content: '200 farmers trained in wet-hulling fermentation and post-harvest processing',
                        risk: 'low' 
                    },
                    { 
                        id: '4', 
                        type: 'activity', 
                        content: 'Conduct 5-day hands-on workshop on fermentation tanks, pH monitoring, and quality control',
                        risk: 'low' 
                    }
                ],
                combData: {
                    '2': {
                        capability: { 
                            score: 4, 
                            notes: 'Farmers struggle with pH testing and timing - need constant monitoring every 6-8 hours' 
                        },
                        opportunity: { 
                            score: 3, 
                            notes: 'Most farmers lack fermentation tanks ($200 each). Water source inconsistent in dry season. Premium buyers require 5-ton minimum order.' 
                        },
                        motivation: { 
                            score: 6, 
                            notes: 'Initial interest high but risk-averse. Many saw neighbors fail with honey-process last year.' 
                        },
                        summary: 'The behavior "adopt wet-hulling technique" requires farmers to: (1) invest in equipment, (2) change daily routine for 72-hour monitoring, (3) trust unproven premium market',
                        intervention: 'Consider: (1) Equipment subsidy or cooperative bulk-purchase, (2) WhatsApp reminder system for monitoring times, (3) Guaranteed purchase contract from roasters to reduce market risk'
                    }
                },
                learningPoints: {
                    en: [
                        "Identify hidden capability barriers (technical skills vs equipment)",
                        "Spot opportunity gaps (access to markets, infrastructure)",
                        "Assess realistic motivation given past failures",
                        "Revise activities to address COM-B gaps"
                    ],
                    id: [
                        "Mengidentifikasi hambatan kemampuan tersembunyi (skill teknis vs peralatan)",
                        "Menemukan gap kesempatan (akses pasar, infrastruktur)",
                        "Menilai motivasi realistis mengingat kegagalan masa lalu",
                        "Merevisi aktivitas untuk mengatasi gap COM-B"
                    ]
                }
            },
            scenario2: {
                id: 'scenario2',
                mode: 'diag',
                titleEN: 'Stunting Reduction Program - East Nusa Tenggara',
                titleID: 'Program Reduksi Stunting - Nusa Tenggara Timur',
                nodes: [
                    { 
                        id: '10', 
                        type: 'impact', 
                        content: 'Reduce stunting prevalence from 42% to 30% in target villages within 3 years',
                        risk: 'low' 
                    },
                    { 
                        id: '11', 
                        type: 'outcome', 
                        content: 'Mothers provide protein-rich complementary food (eggs, fish, tempe) to children 6-24 months daily',
                        risk: 'critical' 
                    },
                    { 
                        id: '12', 
                        type: 'output', 
                        content: '500 sachets of micronutrient powder distributed monthly to 150 mothers through posyandu',
                        risk: 'low' 
                    },
                    { 
                        id: '13', 
                        type: 'activity', 
                        content: 'Monthly posyandu sessions with nutrition counseling and sachet distribution',
                        risk: 'low' 
                    }
                ],
                combData: {
                    '11': {
                        capability: { 
                            score: 4, 
                            notes: 'Mothers know eggs are good but lack knowledge on preparation for 6-9 month olds (texture, avoiding choking). Traditional porridge recipes don\'t include protein sources.' 
                        },
                        opportunity: { 
                            score: 2, 
                            notes: 'Eggs cost Rp2,000 each - unaffordable for daily use (household income Rp30k/day). Fish spoils quickly with no refrigeration. Tempe only available on market day (3x/week).' 
                        },
                        motivation: { 
                            score: 3, 
                            notes: 'Grandmothers believe babies only need breastmilk until teeth appear. Cultural taboo: fish causes worms, eggs cause allergies. Mothers fear social judgment if not following elders.' 
                        },
                        summary: 'Target behavior requires: (1) daily purchase mothers cannot afford, (2) defying mother-in-law authority, (3) preparing food using unknown technique. Output (powder distribution) does not address any of these root barriers.',
                        intervention: 'CRITICAL REVISION NEEDED: (1) Switch to affordable protein (local beans, fish farming), (2) Engage grandmothers in counseling, (3) Cooking demonstrations with age-appropriate recipes, (4) Consider conditional cash transfer or subsidized eggs'
                    }
                },
                learningPoints: {
                    en: [
                        "Diagnose the output-outcome gap (distribution â‰  behavior change)",
                        "Identify economic barriers hidden in 'knowledge' programs",
                        "Recognize social/cultural constraints on mother's autonomy",
                        "Redesign intervention based on COM-B diagnosis"
                    ],
                    id: [
                        "Mendiagnosis gap output-outcome (distribusi â‰  perubahan perilaku)",
                        "Mengidentifikasi hambatan ekonomi tersembunyi di program 'edukasi'",
                        "Mengenali kendala sosial/budaya pada otonomi ibu",
                        "Merancang ulang intervensi berdasarkan diagnosis COM-B"
                    ]
                }
            }
        };

        // --- COMPONENTS (Moved outside App to prevent re-render crashes) ---

        const Toast = ({ message, onClose }) => (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-[120] flex items-center gap-3 animate-slide-up border border-slate-700">
                <i className="fa-solid fa-robot text-amber-400 animate-pulse"></i>
                <span className="text-sm font-medium">{message}</span>
                <button onClick={onClose} className="ml-2 text-slate-400 hover:text-white"><i className="fa-solid fa-times"></i></button>
            </div>
        );

        const RiskTag = ({ level, t }) => {
            const colors = { low: 'bg-emerald-100 text-emerald-700', medium: 'bg-yellow-100 text-yellow-700', high: 'bg-orange-100 text-orange-700', critical: 'bg-red-100 text-red-700' };
            const label = t ? t[`risk_${level}`] : level;
            return <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase ${colors[level]}`}>{label}</span>;
        };

        const RadarChart = ({ data, labels, onChartReady }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    const scores = [
                        data?.capability?.score || 0, 
                        data?.opportunity?.score || 0, 
                        data?.motivation?.score || 0
                    ];

                    chartRef.current = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Behavioral Strength',
                                data: scores,
                                backgroundColor: 'rgba(14, 165, 233, 0.2)',
                                borderColor: '#0ea5e9',
                                borderWidth: 2,
                                pointBackgroundColor: '#0ea5e9',
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: '#e2e8f0' },
                                    grid: { color: '#e2e8f0' },
                                    suggestedMin: 0,
                                    suggestedMax: 10,
                                    ticks: { display: false }
                                }
                            },
                            plugins: { legend: { display: false } },
                            animation: {
                                onComplete: () => {
                                    if(onChartReady && chartRef.current && chartRef.current.canvas) {
                                        try {
                                            onChartReady(chartRef.current.toBase64Image());
                                        } catch(e) {
                                            console.warn("Chart export failed", e);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, labels]);

            return <canvas ref={canvasRef} />;
        };

        const TourOverlay = ({ step, onNext, onSkip, t }) => {
            const steps = [
                { id: 'tour-api', title: t.tour_step1_title, desc: t.tour_step1_desc, pos: 'top-24 left-20' },
                { id: 'tour-canvas', title: t.tour_step2_title, desc: t.tour_step2_desc, pos: 'top-1/3 left-1/4' },
                { id: 'tour-magic', title: t.tour_step3_title, desc: t.tour_step3_desc, pos: 'top-1/2 left-1/4' },
                { id: 'tour-comb', title: t.tour_step4_title, desc: t.tour_step4_desc, pos: 'top-20 right-1/4' },
                { id: 'tour-auto', title: t.tour_step5_title, desc: t.tour_step5_desc, pos: 'top-24 right-40' },
            ];

            const current = steps[step];
            if (!current) return null;

            return (
                <div className="fixed inset-0 z-[110] pointer-events-none">
                    <div className={`absolute ${current.pos} pointer-events-auto bg-white p-6 rounded-xl shadow-2xl max-w-sm border-l-4 border-amber-500 animate-fade-in`}>
                        <div className="flex justify-between items-start mb-2">
                            <h3 className="font-bold text-lg text-slate-800">{current.title}</h3>
                            <button onClick={onSkip} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-times"></i></button>
                        </div>
                        <p className="text-sm text-slate-600 mb-4 leading-relaxed">{current.desc}</p>
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold text-amber-500 uppercase tracking-wider">Step {step + 1}/{steps.length}</span>
                            <button onClick={onNext} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-lg">
                                {step === steps.length - 1 ? t.tour_finish : t.tour_next} <i className="fa-solid fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ArcadeModal = ({ onClose, t }) => (
            <div className="fixed inset-0 z-[200] bg-black/90 flex items-center justify-center font-arcade p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-slate-800 border-4 border-amber-400 p-8 rounded-lg max-w-md text-center shadow-[0_0_50px_rgba(251,191,36,0.3)]">
                    <div className="text-amber-400 text-4xl mb-6 animate-bounce-slow">
                        <i className="fa-solid fa-gamepad"></i>
                    </div>
                    <h2 className="text-white text-xl mb-4 leading-loose tracking-wider arcade-text">PLEASE INSERT<br/><span className="text-amber-400">API KEY</span></h2>
                    <p className="text-slate-400 text-xs font-sans mb-8 leading-relaxed">
                        To unlock the magic powers of AI, you need a Gemini Coin (API Key). It's free!
                    </p>
                    <div className="flex flex-col gap-3">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" className="bg-amber-500 hover:bg-amber-400 text-black py-3 px-6 rounded text-xs font-bold transition-colors shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] active:translate-y-1 active:shadow-none uppercase">
                            GET KEY <i className="fa-solid fa-external-link-alt ml-2"></i>
                        </a>
                        <button onClick={onClose} className="text-slate-500 hover:text-white text-xs mt-2 font-sans underline">
                            I'll enter it later
                        </button>
                    </div>
                </div>
            </div>
        );

        const TutorialCard = ({ scenario, lang, onStart }) => {
            const t = TRANSLATIONS[lang];
            const learningPoints = scenario.learningPoints[lang];
            
            const difficultyColors = {
                'Beginner': 'bg-green-100 text-green-700 border-green-200',
                'Pemula': 'bg-green-100 text-green-700 border-green-200',
                'Intermediate': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                'Menengah': 'bg-yellow-100 text-yellow-700 border-yellow-200',
            };

            const scenarioKey = `tut_scenario${scenario.id.slice(-1)}_`;
            const difficulty = t[scenarioKey + 'difficulty'];

            return (
                <div className="bg-white rounded-xl border border-slate-200 p-6 hover:border-blue-400 hover:shadow-lg transition-all group">
                    <div className="flex items-start justify-between mb-4">
                        <h3 className="text-xl font-bold text-slate-800 group-hover:text-blue-600 transition-colors">
                            {t[scenarioKey + 'title']}
                        </h3>
                        <span className={`text-xs font-bold px-3 py-1 rounded-full border ${difficultyColors[difficulty]}`}>
                            {difficulty}
                        </span>
                    </div>
                    
                    <p className="text-sm text-slate-600 mb-4 leading-relaxed">
                        {t[scenarioKey + 'desc']}
                    </p>

                    <div className="border-t border-slate-100 pt-4 mb-4">
                        <p className="text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            {t.tut_what_learn}
                        </p>
                        <ul className="space-y-1.5">
                            {learningPoints.map((point, idx) => (
                                <li key={idx} className="text-xs text-slate-600 flex items-start gap-2">
                                    <i className="fa-solid fa-check text-green-500 mt-0.5 text-[10px]"></i>
                                    <span>{point}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <button 
                        onClick={() => onStart(scenario)}
                        className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30 group-hover:scale-105"
                    >
                        <i className="fa-solid fa-play"></i>
                        {t.tut_start}
                    </button>
                </div>
            );
        };

        // --- MAIN APPLICATION ---
        function App() {
            const [lang, setLang] = useState('en');
            const [mode, setMode] = useState(null); 
            const [isTutorial, setIsTutorial] = useState(false);
            const [showTutorialModal, setShowTutorialModal] = useState(false);
            const [tourStep, setTourStep] = useState(-1);
            const [showArcadeModal, setShowArcadeModal] = useState(false);
            const [toastMessage, setToastMessage] = useState(null);
            
            const [nodes, setNodes] = useState([]);
            const [projectTitle, setProjectTitle] = useState("");
            const [selectedNodeId, setSelectedNodeId] = useState(null);
            const [combData, setCombData] = useState({});
            const [apiKey, setApiKey] = useState('');
            const [loadingState, setLoadingState] = useState({ global: false, node: null });
            const [chartImage, setChartImage] = useState(null);

            const t = TRANSLATIONS[lang] || TRANSLATIONS['en']; // Safety fallback
            const selectedNode = nodes.find(n => n.id === selectedNodeId);
            const nodeComb = (selectedNodeId && combData[selectedNodeId]) ? combData[selectedNodeId] : getInitialComb();

            // --- INITIALIZATION ---
            const startSession = (sessionMode, isTut, initialData = [], title = "", initialCombData = {}) => {
                setMode(sessionMode);
                setIsTutorial(isTut);
                setNodes(initialData);
                setProjectTitle(title);
                setShowTutorialModal(false);
                setCombData(initialCombData);
                setSelectedNodeId(null);
                if (isTut) {
                    setTourStep(0);
                    if(initialData.length > 0) setTimeout(() => setSelectedNodeId(initialData[0].id), 500); 
                } else {
                    setTourStep(-1);
                }
            };

            const startTutorialScenario = (scenario) => {
                const title = lang === 'id' ? scenario.titleID : scenario.titleEN;
                startSession(scenario.mode, true, scenario.nodes, title, scenario.combData);
            };

            // --- CORE LOGIC ---
            const handleNodeClick = (id) => {
                setSelectedNodeId(id);
                if (!combData[id]) setCombData(prev => ({ ...prev, [id]: getInitialComb() }));
            };

            const addNode = (type) => {
                const newId = Date.now().toString();
                const newNode = { id: newId, type, content: '', risk: 'low' };
                setNodes(prev => [...prev, newNode]);
                handleNodeClick(newId);
            };

            const updateNode = (id, field, value) => {
                setNodes(nodes.map(n => n.id === id ? { ...n, [field]: value } : n));
            };

            const deleteNode = (id, e) => {
                e.stopPropagation();
                setNodes(nodes.filter(n => n.id !== id));
                if (selectedNodeId === id) setSelectedNodeId(null);
            };

            const updateComb = (category, field, value) => {
                setCombData(prev => {
                    const existingNode = prev[selectedNodeId] || getInitialComb();
                    const existingCat = existingNode[category] || { score: 5, notes: '' };
                    return { ...prev, [selectedNodeId]: { ...existingNode, [category]: { ...existingCat, [field]: value } } };
                });
                setTimeout(() => calculateRisk(selectedNodeId), 0);
            };

            const calculateRisk = (nodeId) => {
                setCombData(current => {
                    const data = current[nodeId];
                    if (!data) return current;
                    const c = data.capability?.score || 5;
                    const o = data.opportunity?.score || 5;
                    const m = data.motivation?.score || 5;
                    const avg = (parseInt(c) + parseInt(o) + parseInt(m)) / 3;
                    let risk = 'low';
                    if (avg < 4) risk = 'critical';
                    else if (avg < 6) risk = 'high';
                    else if (avg < 8) risk = 'medium';
                    setNodes(prev => prev.map(n => n.id === nodeId ? { ...n, risk } : n));
                    return current;
                });
            };

            // --- SAVE / LOAD ---
            const saveProject = () => {
                const data = { nodes, combData, mode, lang, projectTitle };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `impact_architect_${projectTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const loadProject = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.nodes) setNodes(data.nodes);
                        if(data.combData) setCombData(data.combData);
                        if(data.mode) setMode(data.mode);
                        if(data.projectTitle) setProjectTitle(data.projectTitle);
                        alert("Project loaded!");
                    } catch(err) { alert("Invalid file"); }
                };
                reader.readAsText(file);
            };

            // --- AI INTEGRATION (Single Model with Retry) ---
            const callGemini = async (prompt, systemInstruction = "") => {
                if (!apiKey) {
                    setShowArcadeModal(true);
                    return null;
                }
                
                // ONLY use the preview model as per system instructions
                const model = 'gemini-2.5-flash-preview-09-2025';
                const delays = [1000, 2000, 4000, 8000, 16000];

                for (let attempt = 0; attempt <= delays.length; attempt++) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                contents: [{ parts: [{ text: prompt }] }], 
                                systemInstruction: { parts: [{ text: systemInstruction }] } 
                            })
                        });

                        if (!res.ok) {
                            const status = res.status;
                            
                            // Retry only on 429 (Rate Limit) or 503 (Service Unavailable)
                            if (status === 429 || status === 503) {
                                if (attempt < delays.length) {
                                    setToastMessage(`â³ Server sibuk (Percobaan ${attempt + 1}/${delays.length}). Tunggu sebentar...`);
                                    await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                                    continue; 
                                }
                            }

                            const errText = await res.text();
                            console.error(`Gemini API Error (${model}):`, errText);
                            setToastMessage(`âŒ Error ${status}: Cek API Key atau Kuota.`);
                            setTimeout(() => setToastMessage(null), 5000);
                            return null;
                        }

                        const data = await res.json();
                        if (attempt > 0) {
                             setToastMessage("âœ… Terhubung kembali!");
                             setTimeout(() => setToastMessage(null), 2000);
                        }
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;

                    } catch (e) { 
                        console.error("Fetch error:", e);
                        if (attempt < delays.length) {
                             await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                             continue;
                        }
                        setToastMessage("âŒ Gagal koneksi internet.");
                        return null;
                    }
                }
                return null;
            };

            const aiFillNode = async (nodeId, type, currentContent) => {
                setLoadingState({ global: false, node: nodeId });
                
                const nodeIndex = nodes.findIndex(n => n.id === nodeId);
                const previousNodes = nodes.slice(0, nodeIndex).map(n => `[${n.type.toUpperCase()}]: ${n.content}`).join(" -> ");
                const context = previousNodes ? `Context so far: ${previousNodes}` : "This is the first step of the program.";
                
                const prompt = `
                    You are an expert policy consultant. 
                    ${context}
                    
                    Task: Generate a realistic, specific, and logical content for the NEXT step which is a: ${type.toUpperCase()}.
                    The current draft content is: "${currentContent}" (if empty, generate from scratch).
                    
                    Rules:
                    1. Output ONLY the content text. No labels, no quotes.
                    2. Be concise but specific.
                    3. Ensure logical flow from previous steps.
                `;
                
                const res = await callGemini(prompt, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if (res) updateNode(nodeId, 'content', res);
                setLoadingState({ global: false, node: null });
            };

            const aiAutoCompleteAll = async () => {
                setLoadingState({ global: true, node: null });
                for (const node of nodes) {
                    if (!node.content || node.content.trim() === '') {
                        await aiFillNode(node.id, node.type, "");
                        await new Promise(r => setTimeout(r, 2000)); // Increased delay for safety
                    }
                }
                setLoadingState({ global: false, node: null });
            };

            const aiMagicComb = async () => {
                if (!selectedNodeId) {
                    alert("Please select a node first.");
                    return;
                }
                const targetNode = nodes.find(n => n.id === selectedNodeId);
                
                if (!targetNode) {
                    console.error("Node not found:", selectedNodeId);
                    return;
                }

                setLoadingState({ global: true, node: 'magic_comb' });
                
                const prompt = `Analyze: "${targetNode.content}". Estimate behavioral scores (1-10) for Capability, Opportunity, Motivation. Provide very short notes for each. Return valid JSON ONLY: { "c_score": 5, "c_note": "...", "o_score": 5, "o_note": "...", "m_score": 5, "m_note": "..." }`;
                
                const res = await callGemini(prompt, "You are a JSON generator.");
                if (res) {
                    try {
                        const cleanRes = res.replace(/```json/g, '').replace(/```/g, '');
                        const json = JSON.parse(cleanRes);
                        setCombData(prev => ({
                            ...prev,
                            [selectedNodeId]: {
                                ...(prev[selectedNodeId] || getInitialComb()),
                                capability: { score: json.c_score, notes: json.c_note },
                                opportunity: { score: json.o_score, notes: json.o_note },
                                motivation: { score: json.m_score, notes: json.m_note },
                                summary: "Auto-diagnosed by AI"
                            }
                        }));
                        setTimeout(() => calculateRisk(selectedNodeId), 500);
                    } catch (e) { console.error("JSON Parse Error", e); }
                }
                setLoadingState({ global: false, node: null });
            };

            const aiAnalyzeBehavior = async () => {
                if (!selectedNodeId) return;
                const targetNode = nodes.find(n => n.id === selectedNodeId);
                if (!targetNode) return;

                setLoadingState({ global: true, node: 'analyze_btn' });
                const res = await callGemini(`Analyze specific behavior for: "${targetNode.content}". Identify WHO needs to do WHAT.`, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if(res) setCombData(prev => ({ ...prev, [selectedNodeId]: { ...(prev[selectedNodeId] || getInitialComb()), summary: res } }));
                setLoadingState({ global: false, node: null });
            };

            const aiSuggestIntervention = async () => {
                 if (!selectedNodeId) return;
                 const targetNode = nodes.find(n => n.id === selectedNodeId);
                 if (!targetNode) return;

                setLoadingState({ global: true, node: 'intervention_btn' });
                const d = nodeComb;
                const prompt = `Scores C:${d.capability.score}, O:${d.opportunity.score}, M:${d.motivation.score} for "${targetNode.content}". Suggest 3 interventions.`;
                const res = await callGemini(prompt, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}.`);
                if(res) setCombData(prev => ({ ...prev, [selectedNodeId]: { ...(prev[selectedNodeId] || getInitialComb()), intervention: res } }));
                setLoadingState({ global: false, node: null });
            };

            const exportReport = async () => {
                if(!apiKey) { setShowArcadeModal(true); return; }
                setLoadingState({ global: true, node: 'export' });

                const w = window.open('', '_blank');
                if (w) {
                    w.document.write('<html><head><title>Generating Report...</title><style>body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;background:#f8fafc;color:#1e293b}h1{color:#0ea5e9}</style></head><body><h1>ImpactArchitect AI</h1><p>Writing your strategic report... Please wait.</p></body></html>');
                }

                const tocText = nodes.map(n => `[${n.type}] ${n.content}`).join(' -> ');
                const aiReport = await callGemini(`
                    Review this Theory of Change: ${tocText}.
                    Project Title: ${projectTitle}.
                    Write a comprehensive strategic report including:
                    1. Executive Summary
                    2. Logic Flow Analysis
                    3. Behavioral Risk Assessment
                    4. Strategic Recommendations.
                    Use Markdown.
                `, `Respond in ${lang === 'id' ? 'Indonesian' : 'English'}. Professional consultant tone.`);

                setLoadingState({ global: false, node: null });

                const html = `
                    <html><head><title>ImpactArchitect Report: ${projectTitle}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Plus Jakarta Sans', sans-serif; padding: 40px; color: #1e293b; max-width: 900px; margin: 0 auto; line-height: 1.6; }
                        h1 { color: #0f172a; border-bottom: 3px solid #0ea5e9; padding-bottom: 15px; margin-bottom: 20px; font-size: 24px; }
                        h2 { color: #0ea5e9; margin-top: 30px; font-size: 18px; border-left: 4px solid #0ea5e9; padding-left: 10px; }
                        .diagram-container { background: #f8fafc; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; margin: 20px 0; text-align: center; }
                        .node-box { 
                            padding: 10px 15px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; 
                            margin: 10px auto; width: 80%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: left; position: relative;
                        }
                        .arrow { color: #cbd5e1; font-size: 20px; margin: 5px 0; }
                        .badge { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #64748b; margin-bottom: 5px; display: block; }
                        .risk-high { border-left: 4px solid #f97316; } .risk-critical { border-left: 4px solid #ef4444; }
                        .ai-content { background: #fff; padding: 20px; border-radius: 8px; }
                        .radar-snapshot { float: right; width: 300px; margin: 0 0 20px 20px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
                        .footer { margin-top: 50px; border-top: 1px solid #eee; padding-top: 20px; font-size: 12px; color: #94a3b8; text-align: center; }
                    </style>
                    </head><body>
                    <h1>${projectTitle || 'Strategic Report'}</h1>
                    <p><strong>Generated by:</strong> ImpactArchitect AI | <strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    
                    <h2>1. Theory of Change Diagram</h2>
                    <div class="diagram-container">
                        ${nodes.map((n, i) => `
                            <div class="node-box ${n.risk === 'high' || n.risk === 'critical' ? 'risk-' + n.risk : ''}">
                                <span class="badge">${n.type}</span>
                                <strong>${n.content}</strong>
                            </div>
                            ${i < nodes.length - 1 ? '<div class="arrow">â†“</div>' : ''}
                        `).join('')}
                    </div>

                    ${chartImage ? `<img src="${chartImage}" class="radar-snapshot" />` : ''}

                    <h2>2. AI Strategic Analysis</h2>
                    <div class="ai-content">
                        ${marked.parse(aiReport || 'Analysis unavailable.')}
                    </div>

                    <h2>3. Detailed Behavioral Register</h2>
                    ${Object.entries(combData).map(([k,v]) => {
                         const n = nodes.find(x=>x.id===k);
                         return n ? `<div class="node-box"><strong>Target:</strong> ${n.content}<br><br><strong>Diagnosis:</strong> ${v.summary}<br><strong>Intervention:</strong> ${v.intervention}</div>` : ''
                    }).join('')}
                    
                    <div class="footer">
                        Created by <strong>Angga Conni Saputra</strong> using ImpactArchitect
                    </div>
                    <script>window.print()<\/script></body></html>
                `;
                
                if (w) {
                    w.document.open();
                    w.document.write(html);
                    w.document.close();
                } else {
                    alert("Please allow popups to view the report.");
                }
            };

            // --- RENDER ---
            if (!mode) return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white relative overflow-hidden">
                     <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '30px 30px'}}></div>
                    
                    {/* Language Button for Landing Page - Keep as is per user request */}
                    <button onClick={() => setLang(lang === 'en' ? 'id' : 'en')} className="absolute top-6 right-6 text-xs font-bold bg-slate-800 px-3 py-1 rounded border border-slate-700 hover:border-blue-500 z-10">{lang.toUpperCase()}</button>
                    
                    <div className="max-w-4xl w-full z-10">
                        <div className="text-center mb-12">
                            <h1 className="text-6xl font-bold mb-4 tracking-tight flex justify-center items-center gap-4">
                                <span className="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">ImpactArchitect</span>
                            </h1>
                            <p className="text-slate-400 text-xl font-light">Behaviorally-Informed Policy IDE</p>
                        </div>
                        
                        {/* UPDATED MENU LAYOUT - 2 COLUMNS */}
                        <div className="grid md:grid-cols-2 gap-8">
                            <button onClick={() => startSession('design', false, [], "New Program Strategy")} className="group bg-slate-800/80 backdrop-blur p-10 rounded-2xl border border-slate-700 hover:border-blue-500 transition-all hover:-translate-y-2 text-left h-full flex flex-col relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-blue-500/10 rounded-bl-full -mr-4 -mt-4 transition-all group-hover:bg-blue-500/20"></div>
                                <div className="w-14 h-14 bg-blue-500/20 rounded-xl flex items-center justify-center mb-6 border border-blue-500/30"><i className="fa-solid fa-layer-group text-2xl text-blue-400"></i></div>
                                <h2 className="text-2xl font-bold mb-1 text-white">{t.lp_new_title}</h2>
                                <span className="text-xs font-bold text-blue-400 uppercase tracking-widest mb-3">{t.lp_new_subtitle}</span>
                                <p className="text-sm text-slate-400 leading-relaxed">{t.lp_new_desc}</p>
                            </button>

                            <button onClick={() => setShowTutorialModal(true)} className="group bg-slate-800/80 backdrop-blur p-10 rounded-2xl border border-slate-700 hover:border-amber-500 transition-all hover:-translate-y-2 text-left h-full flex flex-col relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-24 h-24 bg-amber-500/10 rounded-bl-full -mr-4 -mt-4 transition-all group-hover:bg-amber-500/20"></div>
                                <div className="w-14 h-14 bg-amber-500/20 rounded-xl flex items-center justify-center mb-6 border border-amber-500/30"><i className="fa-solid fa-graduation-cap text-2xl text-amber-400"></i></div>
                                <h2 className="text-2xl font-bold mb-1 text-white">{t.lp_tut_title}</h2>
                                <span className="text-xs font-bold text-amber-400 uppercase tracking-widest mb-3">{t.lp_tut_subtitle}</span>
                                <p className="text-sm text-slate-400 leading-relaxed">{t.lp_tut_desc}</p>
                            </button>
                        </div>

                        {/* NAME FOOTER */}
                        <div className="mt-16 text-center text-slate-600 text-sm">
                            <p>Created by <span className="text-slate-400 font-bold">Angga Conni Saputra</span></p>
                        </div>
                    </div>
                    
                    {/* TUTORIAL MODAL */}
                    {showTutorialModal && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto">
                            <div className="bg-white text-slate-900 rounded-2xl p-8 max-w-4xl w-full my-8 animate-fade-in shadow-2xl">
                                <div className="flex items-start justify-between mb-6">
                                    <div>
                                        <h3 className="text-2xl font-bold mb-2 flex items-center gap-3">
                                            <i className="fa-solid fa-graduation-cap text-amber-500"></i> 
                                            {t.lp_modal_title}
                                        </h3>
                                        <p className="text-sm text-slate-600">
                                            {lang === 'id' 
                                                ? 'Praktikkan audit & revisi ToC menggunakan data riil yang sudah disiapkan'
                                                : 'Practice auditing & revising ToC using pre-populated real-world data'}
                                        </p>
                                    </div>
                                    <button 
                                        onClick={() => setShowTutorialModal(false)} 
                                        className="text-slate-400 hover:text-slate-600 text-2xl w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100 transition-colors"
                                    >
                                        <i className="fa-solid fa-times"></i>
                                    </button>
                                </div>
                                
                                <div className="grid md:grid-cols-2 gap-6">
                                    {Object.values(TUTORIAL_SCENARIOS).map(scenario => (
                                        <TutorialCard 
                                            key={scenario.id} 
                                            scenario={scenario} 
                                            lang={lang}
                                            onStart={startTutorialScenario}
                                        />
                                    ))}
                                </div>

                                <div className="mt-6 pt-6 border-t border-slate-200">
                                    <button 
                                        onClick={() => setShowTutorialModal(false)} 
                                        className="w-full py-3 text-sm font-bold text-slate-600 hover:text-slate-800 hover:bg-slate-50 rounded-lg transition-colors"
                                    >
                                        <i className="fa-solid fa-arrow-left mr-2"></i>
                                        {t.tut_back}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-800">
                    {showArcadeModal && <ArcadeModal onClose={() => setShowArcadeModal(false)} t={t} />}
                    {isTutorial && tourStep >= 0 && <TourOverlay step={tourStep} t={t} onNext={() => setTourStep(prev => prev >= 4 ? -1 : prev + 1)} onSkip={() => setTourStep(-1)} />}
                    {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}

                    <nav className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-50 relative shadow-sm">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setMode(null)} className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white hover:bg-slate-700 transition-colors"><i className="fa-solid fa-home"></i></button>
                            <div>
                                <h1 className="font-bold text-lg leading-tight tracking-tight">ImpactArchitect <span className="text-blue-500">2.9</span></h1>
                                <div className="flex items-center gap-2">
                                    <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded text-white ${isTutorial ? 'bg-amber-500' : 'bg-blue-500'}`}>{isTutorial ? 'SANDBOX' : t.mode_label.toUpperCase()}</span>
                                    {/* MOVED LANGUAGE BUTTON HERE */}
                                    <button onClick={() => setLang(lang === 'en' ? 'id' : 'en')} className="text-[9px] font-bold bg-slate-100 hover:bg-slate-200 px-2 py-0.5 rounded text-slate-500 transition-colors">{lang.toUpperCase()}</button>
                                    <span className="text-[9px] text-slate-400 font-medium">by Angga Conni Saputra</span>
                                </div>
                            </div>
                        </div>
                        <div className={`flex-1 max-w-md mx-6 ${tourStep === 0 ? 'tour-highlight' : ''}`}>
                            <div className={`flex items-center gap-3 bg-slate-50 border transition-colors rounded-lg px-3 py-1.5 ${apiKey ? 'border-emerald-500/50 bg-emerald-50/30' : 'border-slate-200 focus-within:border-blue-500'}`}>
                                <div className={`status-dot shrink-0 ${apiKey ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-slate-300'}`} title={apiKey ? t.api_connected : t.api_disconnected}></div>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder={t.placeholder_api} className="w-full bg-transparent text-xs font-medium focus:outline-none text-slate-700 placeholder-slate-400" />
                            </div>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-[10px] text-blue-500 hover:text-blue-700 font-medium ml-1 mt-1 block flex items-center gap-1"><i className="fa-solid fa-external-link-alt"></i> {t.get_api_key}</a>
                        </div>
                        <div className={`flex items-center gap-3 ${tourStep === 4 ? 'tour-highlight' : ''}`}>
                            {/* REMOVED LANGUAGE BUTTON FROM HERE */}
                            <button onClick={aiAutoCompleteAll} disabled={loadingState.global} className={`flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20 ${loadingState.global ? 'opacity-70 cursor-wait' : ''}`}>
                                {loadingState.global ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles text-purple-400"></i>}
                                {t.btn_auto_complete}
                            </button>
                            <div className="flex gap-1">
                                <label className="p-2 text-slate-400 hover:text-blue-600 transition-colors cursor-pointer" title="Load JSON"><input type="file" accept=".json" onChange={loadProject} className="hidden" /><i className="fa-solid fa-upload"></i></label>
                                <button onClick={saveProject} className="p-2 text-slate-400 hover:text-blue-600 transition-colors" title="Save JSON"><i className="fa-solid fa-download"></i></button>
                                <button onClick={exportReport} disabled={loadingState.global} className="p-2 text-slate-400 hover:text-blue-600 transition-colors" title={t.btn_export}>{loadingState.node === 'export' ? <i className="fa-solid fa-circle-notch fa-spin"></i> : <i className="fa-solid fa-print"></i>}</button>
                            </div>
                        </div>
                    </nav>

                    <div className="flex-1 flex overflow-hidden">
                        <div className={`flex-1 bg-slate-50/50 relative overflow-hidden flex flex-col ${tourStep === 1 ? 'tour-highlight' : ''}`}>
                            <div className="h-12 border-b border-slate-200 bg-white/80 backdrop-blur px-6 flex items-center gap-4 z-10">
                                <span className="text-xs font-bold text-slate-400 uppercase tracking-widest mr-2">{t.toc_title}</span>
                                {Object.keys(NODE_TYPES).map(type => (
                                    <button key={type} onClick={() => addNode(type)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider transition-all hover:scale-105 border ${NODE_TYPES[type].bg} ${NODE_TYPES[type].border}`}>
                                        <i className={`fa-solid ${NODE_TYPES[type].icon} opacity-60`}></i>
                                        {t[NODE_TYPES[type].key].split(' ')[0]} <span className="ml-1 opacity-50">+</span>
                                    </button>
                                ))}
                            </div>
                            <div className="flex-1 overflow-y-auto overflow-x-hidden relative p-8 custom-scrollbar">
                                <div className="metro-line"></div>
                                <div className="w-full px-8 space-y-8 pb-20 relative z-10">
                                    <input 
                                        type="text" 
                                        value={projectTitle} 
                                        onChange={(e) => setProjectTitle(e.target.value)} 
                                        className={`text-4xl font-bold text-slate-800 bg-transparent border-none focus:ring-0 w-full text-center mb-12 placeholder-slate-300 focus:bg-white/50 rounded-xl transition-all ${tourStep === 1 ? 'animate-pulse' : ''}`}
                                        placeholder={t.placeholder_project} 
                                    />

                                    {nodes.length === 0 ? (
                                        <div className="text-center py-20 opacity-40">
                                            <i className="fa-solid fa-diagram-project text-6xl mb-4 text-slate-300"></i>
                                            <p className="text-slate-500 font-medium">{t.empty_state}</p>
                                        </div>
                                    ) : (
                                        ['impact', 'outcome', 'output', 'activity'].map(layer => {
                                            const layerNodes = nodes.filter(n => n.type === layer);
                                            if (layerNodes.length === 0) return null;
                                            return (
                                                <div key={layer} className="relative mb-16">
                                                    <div className="flex justify-center items-center mb-6">
                                                        <div className={`h-px w-12 bg-slate-300 mr-3`}></div>
                                                        <span className={`text-sm font-bold uppercase tracking-widest text-slate-500`}>
                                                            {t[NODE_TYPES[layer].key]}
                                                        </span>
                                                        <div className={`h-px w-12 bg-slate-300 ml-3`}></div>
                                                    </div>
                                                    {/* UPDATED: Vertical Layout Stack */}
                                                    <div className="flex flex-col items-center gap-4 w-full">
                                                        {layerNodes.map(node => (
                                                            <div key={node.id} onClick={() => handleNodeClick(node.id)} className={`node-card group relative bg-white rounded-xl border p-6 cursor-pointer w-full max-w-3xl ${selectedNodeId === node.id ? 'border-blue-500 ring-4 ring-blue-500/10' : 'border-slate-200'} ${node.risk === 'critical' ? 'border-l-4 border-l-red-500' : ''}`}>
                                                                <button onClick={(e) => { e.stopPropagation(); aiFillNode(node.id, node.type, node.content); }} className={`absolute top-2 right-2 w-6 h-6 rounded flex items-center justify-center text-slate-300 hover:text-purple-500 hover:bg-purple-50 transition-colors ${tourStep === 2 ? 'bg-amber-100 text-amber-500 animate-bounce-slow shadow-lg ring-2 ring-amber-400' : ''}`} title={t.magic_hint}>
                                                                    {loadingState.node === node.id ? <i className="fa-solid fa-circle-notch fa-spin text-xs"></i> : <i className="fa-solid fa-wand-magic-sparkles text-xs"></i>}
                                                                </button>
                                                                <div className="flex items-start gap-4">
                                                                    <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${NODE_TYPES[node.type].color} flex items-center justify-center text-white shadow-md shrink-0`}><i className={`fa-solid ${NODE_TYPES[node.type].icon} text-lg`}></i></div>
                                                                    <div className="flex-1">
                                                                        <textarea 
                                                                            value={node.content} 
                                                                            onChange={(e) => updateNode(node.id, 'content', e.target.value)} 
                                                                            onInput={(e) => { e.target.style.height = "auto"; e.target.style.height = e.target.scrollHeight + "px"; }}
                                                                            placeholder={t.placeholder_node} 
                                                                            className="w-full bg-transparent border-none p-0 text-base font-medium text-slate-700 placeholder-slate-300 focus:ring-0 resize-none leading-relaxed overflow-hidden" 
                                                                            rows={4} 
                                                                        />
                                                                        <div className="flex items-center justify-between mt-4 pt-3 border-t border-slate-50">
                                                                            <RiskTag level={node.risk} t={t} />
                                                                            <button onClick={(e) => deleteNode(node.id, e)} className="text-slate-300 hover:text-red-400 text-sm"><i className="fa-solid fa-trash"></i></button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className={`w-[400px] bg-white border-l border-slate-200 flex flex-col shadow-2xl z-30 transition-transform duration-300 ${!selectedNode ? 'translate-x-full absolute right-0 h-full' : 'translate-x-0 relative'} ${tourStep === 3 ? 'tour-highlight' : ''}`}>
                            {selectedNode ? (
                                <>
                                    <div className="h-14 border-b border-slate-100 flex items-center justify-between px-6 bg-slate-50">
                                        <div className="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-wide"><i className="fa-solid fa-sliders text-blue-500"></i> {t.comb_title}</div>
                                        <div className="flex gap-2">
                                            <button onClick={aiMagicComb} className="w-6 h-6 rounded flex items-center justify-center text-purple-500 bg-purple-50 hover:bg-purple-100 transition-colors" title="Magic Auto-Diagnose">
                                                {loadingState.node === 'magic_comb' ? <i className="fa-solid fa-circle-notch fa-spin text-xs"></i> : <i className="fa-solid fa-wand-magic-sparkles text-xs"></i>}
                                            </button>
                                            <button onClick={() => setSelectedNodeId(null)} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-xmark"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                                        <div className="h-48 mb-6 relative">
                                            <RadarChart data={nodeComb} labels={[t.capability, t.opportunity, t.motivation]} onChartReady={setChartImage} />
                                        </div>
                                        <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-6 flex items-start gap-3">
                                            <i className="fa-solid fa-info-circle text-blue-500 mt-0.5"></i>
                                            <p className="text-xs text-blue-800 leading-relaxed">{t.manual_input_hint}</p>
                                        </div>
                                        <div className="space-y-6">
                                            {['capability', 'opportunity', 'motivation'].map(domain => {
                                                const domainData = nodeComb[domain] || { score: 5, notes: '' };
                                                return (
                                                    <div key={domain} className="group">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <label className="capitalize text-sm font-bold text-slate-700">{t[domain]}</label>
                                                            <span className="text-xs font-mono font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded">{domainData.score}/10</span>
                                                        </div>
                                                        <input type="range" min="1" max="10" value={domainData.score} onChange={(e) => updateComb(domain, 'score', e.target.value)} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2" />
                                                        <textarea value={domainData.notes} onChange={(e) => updateComb(domain, 'notes', e.target.value)} placeholder={`Notes for ${t[domain]}...`} className="w-full text-xs p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-blue-400 transition-colors resize-none" rows={2}></textarea>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="mt-8 pt-6 border-t border-slate-100">
                                            <div className="flex justify-between items-center mb-4">
                                                <h4 className="text-sm font-bold text-slate-800"><i className="fa-solid fa-robot text-purple-500 mr-2"></i>{t.ai_feature}</h4>
                                                <div className="flex gap-2">
                                                    <button onClick={aiAnalyzeBehavior} disabled={loadingState.node === 'analyze_btn'} className={`text-[10px] font-bold bg-white border border-slate-200 px-2 py-1 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors ${loadingState.node === 'analyze_btn' ? 'opacity-50' : ''}`}>
                                                        {loadingState.node === 'analyze_btn' ? <i className="fa-solid fa-circle-notch fa-spin mr-1"></i> : null} Analysis
                                                    </button>
                                                    <button onClick={aiSuggestIntervention} disabled={loadingState.node === 'intervention_btn'} className={`text-[10px] font-bold bg-white border border-slate-200 px-2 py-1 rounded hover:bg-purple-50 hover:text-purple-600 transition-colors ${loadingState.node === 'intervention_btn' ? 'opacity-50' : ''}`}>
                                                        {loadingState.node === 'intervention_btn' ? <i className="fa-solid fa-circle-notch fa-spin mr-1"></i> : null} Intervention
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                {loadingState.global && !loadingState.node ? (
                                                    <div className="animate-pulse flex space-x-4"><div className="flex-1 space-y-2 py-1"><div className="h-2 bg-slate-200 rounded"></div><div className="h-2 bg-slate-200 rounded w-5/6"></div></div></div>
                                                ) : (
                                                    <>
                                                        <div className="p-3 bg-purple-50 border border-purple-100 rounded-lg"><div className="text-[10px] font-bold text-purple-700 uppercase mb-1">Diagnosis</div><p className="text-xs text-slate-700">{nodeComb.summary || "-"}</p></div>
                                                        <div className="p-3 bg-indigo-50 border border-indigo-100 rounded-lg"><div className="text-[10px] font-bold text-indigo-700 uppercase mb-1">Recommendation</div><p className="text-xs text-slate-700 whitespace-pre-line">{nodeComb.intervention || "-"}</p></div>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : null}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
